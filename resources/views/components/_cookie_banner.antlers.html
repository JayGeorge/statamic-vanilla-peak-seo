{{#
    @name Cookie banner
    @desc The cookie banner component defined in `statamic-vanilla-peak-seo::snippets/_seo.antlers.html` and yielded in `resources/views/layout.antlers.html`.
#}}

<!-- statamic-vanilla-peak-seo::components/_cookie.antlers.html -->
<script>
    document.addEventListener('alpine:init', () => {
        Alpine.store('cookieBanner', {
            consent: Alpine.$persist({{ seo:hide_by_default ? true : 'null' }}).as('cookieBannerConsent'),
            embeds: Alpine.$persist(null).as('cookieBannerEmbeds'),
            setConsent(value) {
                this.consent = value
            },
            setEmbeds(value) {
                this.embeds = value
            }
        })
    })
</script>

<div
    x-data="{
        {{# Persist null as untouched banner state. #}}
        cookieConsentDate: $persist(null).as('cookieBannerConsentDate'),
        analyticsStorage: $persist(false).as('cookieBannerAnalyticsStorage'),
        adStorage: $persist(false).as('cookieBannerAdStorage'),
        embeds: $store.cookieBanner.embeds,
        {{ seo:scripts }}
            customScript{{ count }}: $persist(false).as('cookieBannerCustomScript{{ count }}'){{ !last ?= ',' }}
        {{ /seo:scripts }}
    }"
    x-init="
        {{# Hide when banner is interacted with, check date for optional consent revoke. If so set state back to initial state. #}}
        cookieConsentDate < '{{ seo:cookie_revoke_before format="Y-m-d" }}'
            ? ($store.cookieBanner.setConsent(null), cookieConsentDate = null)
            : ''
    "
    {{ if seo:tracker_type !== 'none' || seo:embeds }}
        x-effect="
            {{# Update gtag on state change. #}}
            {{ if seo:tracker_type == 'gtag' || seo:tracker_type == 'gtm'}}
                $store.cookieBanner.consent
                    ? gtag('consent', 'update', {
                        'analytics_storage': (analyticsStorage ? 'granted' : 'denied'),
                        'ad_storage': (adStorage ? 'granted' : 'denied') })
                    : ''
            {{# Fire other scripts upon consent. #}}
            {{ elseif seo:tracker_type == 'scripts' }}
                {{ seo:scripts }}
                    if ($store.cookieBanner.consent && customScript{{ count }}) {
                        {{ script_fragments }}
                            var script{{ index }} = document.createElement('script')
                            {{ if type == 'script_tag' }}
                                script{{ index }}.src = '{{ source }}'
                            {{ else }}
                                script{{ index }}.text = '{{ inline_script | add_slashes | entities | collapse_whitespace }}'
                            {{ /if }}
                            {{ if type != 'body_content' }}
                                {{ defer ?= 'script{{ index }}.defer = true' }}
                                {{ async ?= 'script{{ index }}.async = true' }}
                                {{ _index = index }}
                                {{ inline_script_attributes }}
                                    script{{ _index }}.setAttribute(
                                        '{{ attribute | slugify }}',
                                        '{{ attribute_value ? { attribute_value | entities } : 'true' }}'
                                    )
                                {{ /inline_script_attributes }}
                            {{ /if }}
                            document.head.appendChild(script{{ index }})
                        {{ /script_fragments }}
                    }
                {{ /seo:scripts }}
            {{ /if }}
            {{# Set embeds and dispatch event to embed component(s). #}}
            $store.cookieBanner.setEmbeds(embeds)
            $dispatch('embeds')
        "
    {{ /if }}
    x-show="$store.cookieBanner.consent === null"
    x-transition
    class="
        c-cookie-consent
        {{ seo:display_style == 'left' ?= '' }}
        {{ seo:display_style == 'right' ?= 'c-cookie-consent--r' }}
    "
    x-cloak
>
    <h2>{{ trans:strings.cookie_title }}</h2>
    <p><strong>
        {{ trans:strings.cookie_explanation }}
        {{ if configuration:cookie_notice_type == 'entry' }}
            <a href="{{ configuration:cookie_notice_entry:url }}">{{ trans:strings.cookie_learn_more }}</a>
        {{ elseif configuration:cookie_notice_type == 'pdf' }}
            <a href="{{ configuration:cookie_notice_asset }}" target="_blank">{{ trans:strings.cookie_learn_more }}</a>
        {{ /if }}
    </strong></p>

    <div>
        {{# Functional cookies are always on. #}}
        <label>
            <input type="checkbox" name="functional" checked disabled>
            <span>
                <strong>{{ trans:strings.cookie_functional }}</strong>
                <span>{{ trans:strings.cookie_functional_explanation }}</span>
            </span>
        </label>

        {{# x-model analyticsStorage checkbox. #}}
        {{ if seo:tracker_type == 'gtag' || seo:tracker_type == 'gtm' }}
            <label>
                <input type="checkbox" name="analytics_storage" x-model="analyticsStorage">
                <span>
                    <strong>{{ trans:strings.cookie_analytics }}</strong>
                    <span>{{ trans:strings.cookie_analytics_explanation }}</span>
                </span>
            </label>
        {{ /if }}

        {{# x-model adStorage checkbox only when GTM is being used. #}}
        {{ if seo:tracker_type == 'gtm' }}
            <label>
                <input type="checkbox" name="ad_storage" x-model="adStorage">
                <span>
                    <strong>{{ trans:strings.cookie_ads }}</strong>
                    <span>{{ trans:strings.cookie_ads_explanation }}</span>
                </span>
            </label>
        {{ /if }}

        {{# x-model thirdParty checkbox only when scripts is being used. #}}
        {{ if seo:tracker_type == 'scripts' }}
            {{ seo:scripts }}
                <label>
                    <input type="checkbox" name="customScript{{ count }}" x-model="customScript{{ count }}">
                    <span>
                        <span>{{ category }}</span>
                        <span>{{ explainer }}</span>
                    </span>
                </label>

                {{# Render this stack in all your layouts after opening the <body>. #}}
                {{ script_fragments }}
                    {{ if type == 'body_content' }}
                        {{ push:seo_body }}
                            {{ body_content }}
                        {{ /push:seo_body }}
                    {{ /if }}
                {{ /script_fragments }}
            {{ /seo:scripts }}
        {{ /if }}

        {{# x-model embeds checkbox only when embeds is turned on. #}}
        {{ if seo:embeds }}
            <label>
                <input type="checkbox" name="embeds" x-model="embeds">
                <span>
                    <strong>{{ trans:strings.cookie_embeds }}</strong>
                    <span>{{ trans:strings.cookie_embeds_explanation }}</span>
                </span>
            </label>
        {{ /if }}
    </div>

    <div class="o-hero-buttons o-hero-buttons--left flex space-x-4">
        {{# Save all options. #}}
        <button
            @click="
                cookieConsentDate = '{{ now format="Y-m-d" }}'
                {{ if seo:tracker_type == 'gtag' || seo:tracker_type == 'gtm' }}
                    , analyticsStorage = true
                {{ /if }}
                {{ if seo:tracker_type == 'gtm' }}
                    , adStorage = true
                {{ /if }}
                {{ if seo:tracker_type == 'scripts' }}
                    {{ seo:scripts }}
                        , customScript{{ count }} = true
                    {{ /seo:scripts }}
                {{ /if }}
                {{ if seo:embeds }}
                    , embeds = true
                {{ /if }}
                , $store.cookieBanner.setConsent(true)
            "
            type="button"
            class="c-btn c-btn--s c-btn--1"
            >
            {{ trans:strings.cookie_accept_all }}
        </button>

        {{# Save selected options. #}}
        <button
            @click="
                $store.cookieBanner.setConsent(true),
                cookieConsentDate = '{{ now format="Y-m-d" }}'
            "
            type="button"
            class="c-btn c-btn--s c-btn--2"
        >
            {{ trans:strings.cookie_accept_selected }}
        </button>
    </div>
</div>
<!-- End: statamic-vanilla-peak-seo::components/_cookie_banner.antlers.html -->

{{# Yield this section in `resources/layouts/_footer.antlers.html` so users can reset their consent. #}}
{{ section:reset_cookie_consent }}
    <!-- statamic-vanilla-peak-seo::components/_cookie_banner.antlers.html -->
    {{ if seo:use_cookie_banner }}
        {{# Read out global store consent status and display a reset consent link by saving the initial state. #}}
        <span x-data x-cloak>
            <span x-show="$store.cookieBanner.consent !== null">
                <a @click.prevent="$store.cookieBanner.setConsent(null)" class="{{ reset_cookie_consent_class ?? 'px-1 -mx-1 underline rounded hover:text-primary focus:outline-none focus-visible:ring-2 ring-primary motion-safe:transition-colors' }}" href="#">{{ trans:strings.cookie_change_preferences }}</a>
            </span>
        </span>
    {{ /if }}
    <!-- End: statamic-vanilla-peak-seo::components/_cookie_banner.antlers.html -->
{{ /section:reset_cookie_consent }}
